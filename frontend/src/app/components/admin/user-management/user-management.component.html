<h1>Gestión de Usuarios</h1>
<div class="actions">
  <button mat-raised-button color="primary" (click)="addUser()">Añadir Usuario</button>
  <input [(ngModel)]="searchTerm" placeholder="Buscar usuario..." />
</div>
<!-- añadir nuevo usuario -->
<div class="modal" *ngIf="addUserForm">
  <mat-card class="modal-card">
    <mat-card-title>Nuevo Usuario</mat-card-title>
    <form (ngSubmit)="submitNewUser()" #userForm="ngForm">
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Nombre de usuario</mat-label>
        <input matInput [(ngModel)]="newUser.username" name="username" required />
        <mat-error *ngIf="userForm.submitted && !newUser.username">
          El nombre de usuario es obligatorio
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Email</mat-label>
        <input matInput type="email" name="email" required 
               [(ngModel)]="newUser.email" #emailCtrl="ngModel"
               pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" />
        <mat-error *ngIf="emailCtrl.errors?.['required'] && emailCtrl.touched">
          El email es obligatorio
        </mat-error>
        <mat-error *ngIf="emailCtrl.errors?.['pattern'] && emailCtrl.touched">
          El formato del email no es válido (ejemplo: usuario&#64;dominio.com)
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Contraseña</mat-label>
        <input matInput [(ngModel)]="newUser.password" name="password" 
               type="password" required minlength="7" #passCtrl="ngModel" />
        <mat-error *ngIf="passCtrl.errors?.['required']">
          La contraseña es obligatoria
        </mat-error>
        <mat-error *ngIf="passCtrl.errors?.['minlength']">
          La contraseña debe tener al menos 7 caracteres
        </mat-error>
      </mat-form-field>

      <div class="actions">
        <button mat-raised-button color="primary" type="submit" [disabled]="userForm.invalid">
          Guardar
        </button>
        <button mat-button type="button" (click)="closeAddUser()">Cancelar</button>
      </div>
    </form>
  </mat-card>
</div>


<!-- modal editar usuario -->
<div class="modal" *ngIf="editUserForm && userToEdit">
  <mat-card class="modal-card">
    <mat-card-title>Editar Usuario</mat-card-title>
    <form (ngSubmit)="submitEditUser()" #editForm="ngForm">
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Usuario</mat-label>
        <input matInput [(ngModel)]="userToEdit.username" name="editUsername" required>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Email</mat-label>
        <input matInput [(ngModel)]="userToEdit.email" name="editEmail" required>
      </mat-form-field>

      <div class="actions">
        <button mat-raised-button color="primary" type="submit" [disabled]="editForm.invalid">Guardar</button>
        <button mat-button type="button" (click)="editUserForm = false">Cancelar</button>
      </div>
    </form>
  </mat-card>
</div>


<table>
  <thead>
    <tr>
      <th>Usuario</th>
      <th>Email</th>
      <th>Rol</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let user of filteredUsers">

      <td>{{ user.username }}</td>
      <td>{{ user.email }}</td>
      <td>{{ user.role }}</td>
      <td>
        <button mat-button color="accent" (click)="editUser(user)">Editar</button>
        <button mat-button class="btn-delete" (click)="deleteUser(user.id)">Eliminar</button>
      </td>
    </tr>
  </tbody>
</table>